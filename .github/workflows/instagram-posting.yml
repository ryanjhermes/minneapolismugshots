name: Instagram Posting

on:
  schedule:
    # Every hour from 10:00 AM to 7:00 PM Central (CDT, UTC-5)
    - cron: '0 15-21 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  post-inmates:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # Allow pushing updates to repository
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Add randomized delay for Instagram detection avoidance
      run: |
        # Generate random delay between 0-120 seconds (Â±1 minute)
        RANDOM_DELAY=$((RANDOM % 121))
        echo "ğŸ² Adding random delay of $RANDOM_DELAY seconds to avoid detection patterns"
        sleep $RANDOM_DELAY

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv pytz
        # Install ML dependencies for BLIP filtering
        pip install transformers torch pillow
        echo "âœ… All dependencies installed including BLIP requirements"

    - name: Test BLIP availability
      run: |
        echo "ğŸ¤– Testing BLIP AI filter availability..."
        python -c "
        try:
            from transformers import pipeline, AutoProcessor, AutoModelForVisualQuestionAnswering
            from PIL import Image
            print('âœ… BLIP dependencies available')
        except ImportError as e:
            print(f'âŒ BLIP import error: {e}')
        except Exception as e:
            print(f'âš ï¸  BLIP setup error: {e}')
        "

    - name: Create .env file with secrets
      run: |
        echo "ACCESS_TOKEN=${{ secrets.META_ACCESS_TOKEN }}" >> .env
        echo "APP_ID=${{ secrets.META_APP_ID }}" >> .env
        echo "BUSINESS_ID=${{ secrets.META_BUSINESS_ID }}" >> .env

    - name: Check for posting queue
      id: check_queue
      run: |
        if [ -f "posting_queue.json" ]; then
          echo "queue_exists=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Posting queue found"
        else
          echo "queue_exists=false" >> $GITHUB_OUTPUT
          echo "ğŸ“­ No posting queue found"
        fi

    - name: Post next inmates to Instagram
      if: steps.check_queue.outputs.queue_exists == 'true'
      run: |
        echo "ğŸ“± Posting next batch of inmates to Instagram..."
        python data.py post-next
        echo "âœ… Posting batch completed"

    - name: Clean up posted mugshot files
      if: steps.check_queue.outputs.queue_exists == 'true'
      run: |
        echo "ğŸ—‘ï¸  Cleaning up posted inmates' mugshot files..."
        python data.py cleanup-mugshots
        echo "âœ… Mugshot cleanup completed"

    - name: Add random delay between posts for human-like behavior
      if: steps.check_queue.outputs.queue_exists == 'true'
      run: |
        # Add another small random delay after posting
        RANDOM_DELAY=$((RANDOM % 31 + 10))  # 10-40 seconds
        echo "ğŸ˜´ Adding random post-posting delay of $RANDOM_DELAY seconds"
        sleep $RANDOM_DELAY

    - name: Commit queue updates
      if: steps.check_queue.outputs.queue_exists == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if posting_queue.json was modified
        if git diff --quiet posting_queue.json; then
          echo "ğŸ“­ No queue changes to commit"
        else
          git add posting_queue.json
          git commit -m "Update posting queue - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… Queue updates committed"
        fi
        
        # Check if any mugshot files were deleted
        if git status --porcelain | grep -q "D.*mugshots/"; then
          echo "ğŸ—‘ï¸  Committing deleted mugshot files..."
          git add -A mugshots/
          git commit -m "Clean up posted mugshot files - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… Mugshot cleanup committed"
        else
          echo "ğŸ“­ No mugshot files to clean up"
        fi

    - name: Skip if no queue
      if: steps.check_queue.outputs.queue_exists == 'false'
      run: |
        echo "â­ï¸  No posting queue found - skipping this run"
        echo "ğŸ’¡ Queue will be created when daily scraping runs at 6:00 PM UTC" 